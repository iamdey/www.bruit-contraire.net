---
slug: raf-guitar-tab
title: RAF - √âtude d'une application de tablature dynamique pour guitare
authors:
  name: David Epely
  image_url: https://github.com/iamdey.png
tags: [javascript, musique]
---

import ReactPlayer from 'react-player';
import pocAnimatedUrl from './poc-animated.mp4';
import previewUrl from './preview.mp4';

Suite √† une discussion avec un ami, je me suis lanc√© un petit d√©fi. Il existe
tout un tas de logiciels pour apprendre la musique et en particulier la guitare,
je pense √† ultimate-guitare, yousician, tomplay, sonsterr‚Ä¶. Mais tr√®s peu sont
opensource (coucou [tuxguitar](https://www.tuxguitar.app/)) et encore moins sont
ceux qui poussent l'affichage en tablature dynamique.

Alors j'ai tent√© de voir ce que j'√©tais en mesure de r√©aliser.

![Capture d'√©cran de RAF en action](./raf-in-action.png)

L'id√©e c'est de partir d'un fichier guitar-pro (.gp) qui contient d√©j√† toutes
les informations n√©cessaires pour afficher les √©l√©ments √† l'√©cran‚Ä¶

<!-- truncate -->

En faisant quelques recherches je tombe sur cet incroyable librairie qui permet
de lire les fichiers guitar-pro:
[AlphaTab - music notation and guitar tablature rendering librarie](https://github.com/coderline/alphaTab).
Le site internet permet de voir ce qu'il est possible de faire avec
[www.alphatab.net](https://www.alphatab.net/). Et c'est fou, on a la tablature,
la partition et la possibilit√© de lire le contenu en midi le tout de mani√®re
programmatique.

![Capture d'√©cran de alphaTab v1.2.3- source: https://github.com/CoderLine/alphaTab/](./alphaTab.png)

En gros il n'y a plus qu'√† mettre un peu de glue et √ßa semble √™tre un peu trop
facile:

![Capture d'√©cran avec un peu de code v√©rifiant la faisabilit√©](./poc.png)

Apr√®s quoi √ßa devient enfin un peu compliqu√©, tout bouge, √ßa fait de la musique
mais il me reste √† synchroniser le visuel sur le son.

<ReactPlayer
  controls
  url={pocAnimatedUrl}
  title="Vid√©o montrant le test faisabilit√© de l'application, on voit le titre de la chanson, Killing In The Name de Rage against the machine ainsi qu'une tablature dynamique, des rectangles num√©rot√©s indiques sur quelles frettes de la guitare on doit appuyer et une ligne rouge verticale au milieu de l'√©cran indique quand on doit appuyer. Il n'y pas de son."
/>

J'arrive presque au bout de mon exp√©rimentation, le plus difficile c'est donc de
synchroniser la musique avec l'affichage de la tablature. C'est tr√®s proche du
**d√©veloppement de jeu vid√©o** et c'est vraiment un monde √† part.

<ReactPlayer
  controls
  url={previewUrl}
  title="Vid√©o similaire √† la pr√©c√©dente mais avec le morceau de musique jou√© en midi, la longueur des rectangles num√©rot√©s indique le temps que dure chaque note. On peut voir en bas √† gauche la dur√©e √©coul√©e et √† droite le nombre de FPS qui varie entre 19 et 60."
/>

> hmm ‚Ä¶

Ok, c'est moche, √ßa saccade mais je vais vous expliquer pourquoi (ce n'est pas
un bug, c'est une feature comme toujours üòè).

Ce n'est pas mon m√©tier, ne me jugez pas. Voil√† ce que j'ai appris.

Je lis un fichier qui est capable d'√™tre transcrit en midi et les temps sont
indiqu√©s en ¬´ticks¬ª, mais l'affichage lui ne conna√Æt que les FPS (frame per
second).

Il faut donc trouver un terrain d'entente: _le temps_. Heureusement la formule
est assez simple pour le midi: `ms = 60000 / (BPM \* PPQ)`

Plus de d√©tails dans cette r√©ponse stackoverflow,
[convertir les ticks midi en temps (en)](https://stackoverflow.com/questions/2038313/converting-midi-ticks-to-actual-playback-seconds).

En fonction de la dur√©e d'une mesure et une fois que l'on a d√©termin√© la taille
que l'on veut lui donner √† l'√©cran cela permet de calculer une v√©locit√©. Disons
que nos mesures bougent √† 76.56px par secondes (vous sentez venir la blague?).

Ensuite il ne reste qu'√† d√©placer l‚Äô√©l√©ment de la distance voulue √† chaque
frame, disons de 1.276px √† 60 FPS. Sauf qu'un ordi ne tournera pas forc√©ment √†
60FPS. Mais ouf, on va lui appliquer un delta.

Ce n'est pas termin√© (j'en viens √† la blague), il n'est pas possible d'avancer
d'un demi pixel! Il arrive donc des d√©synchro qu'il faut corriger. Je l'ai fait
grossi√®rement sur le PoC, donc c'est moche, on a l'impression que √ßa saute.

Heureusement, tout ceci est tr√®s bien expliqu√© sur cet article
[game loops and timing](http://isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing)
bas√© certes sur javascript mais j'imagine que les concepts restent les m√™mes
dans d'autres langages.

Le code source de petit projet est disponible sur github,
[RAF - une application pour apprendre √† jouer d'un instrument de musique](https://github.com/iamdey/raf).
Pour l'instant des contraintes techniques ne permettent pas de d√©ployer
l'application mais fonctionne correctement en environnement de d√©veloppement.
